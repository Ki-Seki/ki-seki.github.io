---
date: '2025-07-25T23:17:51+08:00'
title: 'dowhen 开发过程的启发'
tags: ["dowhen", "python"]
---

## `dowhen` 的 `trigger` 执行流

```python
when(entity, identifier, condition, entity_hash)
  1. 判定 condition 是否是语法可执行的
  2. 根据 entity_hash，判定运行时 entity 是否发生大的改变
  TODO
```

## `dowhen` 的 `callback` 执行流

```python
被instrumented的代码行
↓
sys.monitoring  # 监听抽象事件以及绑定回调
↓
instrumenter.py::Instrumenter().*_callback()  # sys.monitoring 绑定的回调
↓
instrumenter.py::Instrumenter()._process_handlers()  # 回调高层包装，添加 sys.monitoring.DISABLE 功能
↓
handler.py::EventHandler().__call__()  # 回调中层包装，添加 event 执行时机判定，has_event 和 should_fire 逻辑
↓
callback.py::Callback().__call__()  # 回调低层包装，添加到 call_code/call_goto/call_bp 的判定
↓
callback.py::Callback.call_*()  # 回调执行
↓
用户定义代码  # 如果是 call_code，则执行用户定义的代码
```
